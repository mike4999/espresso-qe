
Quantum-Espresso restart file specifications - VERY PRELIMINARY
Paolo Giannozzi scripsit AD 2005-11-11 - Last modified 2006-05-10

0) rationale

Requirements: the data file should be
- efficient (quick to read and write)
- easy to read, parse and write without special libraries
- easy to understand (self-documented)
- portable across different software packages
- portable across different computer architectures 
Solutions:
- use binary I/O for large records
- exploit the file system for organizing data
- use XML
- use a small specialized library (iotk) to read, parse, write 
- ensure the possibility to convert to a portable formatted file

1) general structure

- The "restart file" is actually a "restart directory", containing
  several files and sub-directories. For CP/FPMD, the restart directory
  is created as "$prefix_$ndw/", where $prefix is the value of the variable
  "prefix". $ndw the value of variable ndw, both read in input; it is read
  from "$prefix_$ndr/", where $ndr the value of variable ndr, read from input.
  For PWscf, both input and output directories are called "$prefix/".
  The content of the restart directory is as follows.
  - File "data-file.xml" contains
    - general information that doesn't require large data set:
      atomic structure, lattice, symmetries, parameters of the run, ...
    - pointers to other files or directories containing bulkier
      data, such as wavefunctions, charge density, potentials:
      - File "charge_density.xml"
        contains the charge density
      - File "spin_polarization.xml"
        contains the spin polarization (rhoup-rhodw) (LSDA calculations)
      - Files "magnetization.x", "magnetization.y", "magnetization.z": 
        contain the spin polarization (noncollinear calculations)
      - File "mat_z.1"
        contains occupations (ensemble-dynamics only)
      - File "lambda.dat"
        contains occupations (Car-Parrinello dynamics only)
      - A copy of all pseudopotential files given in input
      - One or more subdirectories "K00001/ ", "K00002/", etc, one per
        k-point. Each directory contains 
        - one file "evc.dat". containing the wavefunctions for 
          spin-unpolarized calculations, OR;
        - two files "evc1.dat" and "evc2.dat", containing the spin-up
          and spin-down wavefunctions, respectively, for spin polarized
          (LSDA) calculations
       and, in a molecular dynamics run, also wavefunctions at the
       preceding time step:
        - one file "evcm.dat", OR
        - two files "evcm1.dat" and "evcm2.dat", 

- File "restart.xml" is an XML-compliant, formatted file
- Files "charge_density.rho", "charge_density.rhoup", "charge_density.rhodw",
  "mat_z.1", "lambda.dat" are unformatted fiels, containing a single record
- Files "evc.dat", "evc1.dat", "evc2.dat", "evcm1.dat" "evcm2.dat",
  are XML-compliant files, but they contain an unformatted record

2) Structure of file "restart.xml"

- Header: whatever is needed to have a well-formed XML directory

- Body:
  introduced by <Root>, terminated by </Root>
  Contains first-level tags only. These contain only other tags, 
  not values. XML syntax applies.

  - First-level tags contain either
    - second-level tags
    - "data tags": tags containing data (values for a given variable)
    - "file tags": tags pointing to a file

    - data tags syntax ( [...] = optional )
      <TAG type="vartype" size="n" [UNIT="units"] [LEN="k"]>
         values (in appropriate units) for variable corresponding to TAG:
         n elements of type vartype (if character, of lenght k)
      </TAG>
      where TAG describes the variable into which data must be read;
      "vartype" may be "integer", "real", "character", "logical";
      if type="logical", LEN=k" must be used to specify the length
      of the variable character; size="n" is the dimension.
      Acceptable values for "units" depend on the specific tag.

      "Short" syntax, used only in a few cases:
      <TAG attribute="something"/> . For instance:
      <FFT_GRID nr1="NR1" nr2="NR2" nr3="NR3"/>
        defines	the value of the FFT grid parameters nr1, nr2, nr3
        for the charge density (including augmentation terms of USPP)
      <SMOOTH_FFT_GRID nr1s="NR1" nr2s="NR2" nr3s="NR3"/>
        as above for the FFT grid for the charge density (without
        augmentation terms) and wavefunctions (optional)
      <SMALLBOX_FFT_GRID nr1b="NR1" nr2b="NR2" nr3b="NR3"/>
        as above for the "small box" FFT grid centered around
        atoms to describe the augmentation terms of USPP (optional)

3) Sample:

- Header:

<?xml version="1.0"?>
<?iotk version="1.0.0test"?>
<?iotk file_version="1.0"?>
<?iotk binary="F"?> 

These are meant to be used only by iotk (actually they aren't)

- First-level tags:

  - <STATUS>         (information about the status of the CP simulation)
  - <CELL>           (lattice vector, unit cell, etc)
  - <IONS>           (type and positions of atoms in the unit cell etc)
  - <SYMMETRIES>     (symmetry operations)
  - <PLANE_WAVES>    (basis set, cutoffs etc)
  - <SPIN>           (info on spin polarizaztion)
  - <EXCHANGE_CORRELATION>
  - <OCCUPATIONS>    (occupancy of the states)
  - <BRILLOUIN_ZONE> (k-points etc)
  - <PARALLELISM>    (specialized info for parallel runs)
  - <CHARGE-DENSITY>
  - <TIMESTEPS>      (positions, velocities, nose' thermostats)
  - <BAND_STRUCTURE>

  
- Tag description

  <STATUS>  (optional) contains
     <STEP>   (number $n of steps performed, i.e. we are at step $n)
     <TIME>   (total simulation time)
     <TITLE>  (a job descriptor)
     <ekin>   (kinetic energy)
     <eht>    (hartree energy)
     <esr>    (Ewald term, real-space contribution)
     <eself>  (self-interaction of the Gaussians)
     <epseu>  (pseudopotential energy, local)
     <enl>    (pseudopotential energy, nonlocal)
     <exc>    (exchange-correlation energy)
     <vave>   (average of the potential)
     <enthal> (enthalpy: E+PV)
  </STATUS>

  <CELL>  (needed) contains
     <BRAVAIS_LATTICE>
     <LATTICE_PARAMETER>
     <CELLDM>  (cell parameters)
     <DIRECT_LATTICE_VECTORS>
        <a1>
        <a2>
        <a3>
     <RECIPROCAL_LATTICE_VECTORS>
        <b1>
        <b2>
        <b3>
  </CELL>

  <IONS>
     <NUMBER_OF_ATOMS>
     <NUMBER_OF_SPECIES>
     For each species $X:
        <ATOM_TYPE>
        <$X_MASS>
        <PSEUDO_FOR_$X>
    <UNITS_FOR_ATOMIC_POSITIONS>
    <For each atom $n of species $X:
        <ATOM.$n SPECIES="$X">
  </IONS>

  <SYMMETRIES>
     <NUMBER_OF_SYMMETRIES>
     <INVERSION_SYMMETRY>
     For each symmetry $n:
        <SYMM.$n>

  <PLANE_WAVES>
    <WFC_CUTOFF>
    <RHO_CUTOFF>
    <MAX_NPW>
    <GAMMA_ONLY>
    <FFT_GRID>
    <GVECT_NUMBER>
    <SMOOTH_FFT_GRID>
    <SMOOTH_GVECT_NUMBER>
    <G-VECTORS_FILE>       link to file "gvectors.dat"
    <SMALLBOX_FFT_GRID>

  <SPIN>
    <LSDA>
    <NON-COLINEAR_CALCULATION>
    <SPIN-ORBIT_CALCULATION>
  </SPIN>

  <EXCHANGE_CORRELATION>
    <DFT>
    <LDA_PLUS_U_CALCULATION>
  </EXCHANGE_CORRELATION>

  <OCCUPATIONS>
    <SMEARING_METHOD>
    <TETRAHEDRON_METHOD>
    <FIXED_OCCUPATIONS>
    <INPUT_OCC_UP>
  </OCCUPATIONS>

  <BRILLOUIN_ZONE>
    <NUMBER_OF_K-POINTS>
    <UNITS_FOR_K-POINTS>
    For each k-point $n:
       <K-POINT.$n>
  </BRILLOUIN_ZONE>

  <PARALLELISM>
     <GRANULARITY_OF_K-POINTS_DISTRIBUTION>
  </PARALLELISM>

  <CHARGE-DENSITY>
     <RHO_FILE>  link to file "charge_density.rho"
  </CHARGE-DENSITY>

  <TIMESTEPS>
     For each time step $n=0,M
       <STEP$n>
          <ACCUMULATORS>
          <IONS_POSITIONS>
             <stau>
             <svel>
             <taui>
             <cdmi>
             <force>
          <IONS_NOSE>
             <nhpcl>
             <nhpdim>
             <xnhp>
             <vnhp>
          <ekincm>
          <ELECTRONS_NOSE>
             <xnhe>
             <vnhe>
          <CELL_PARAMETERS>
             <ht>
             <htve>
             <gvel>
          <CELL_NOSE>
             <xnhh>
             <vnhh>
          </CELL_NOSE>

   <BAND_STRUCTURE>
      <NUMBER_OF_SPIN_COMPONENTS>
      <NUMBER_OF_ELECTRONS>
      <NUMBER_OF_BANDS>
      <EIGENVALUES_AND_EIGENVECTORS>
      For all kpoint $n:
        <K-POINT.$n>
           <K-POINT_COORDS>
           <WEIGHT>
           <ET.$n>
           <OCC0.$n>
           <OCCM.$n>   (optional)
           <gkvectors> link to file "./K$n/gkvectors.dat"
           <wfc>       link to file "./K$n/evc.dat" containing
                       wavefunctions at current step
           <wfcm>      link to file "./K$n/evcm.dat" (optional)
                       containing wavefunctions at preceding step

